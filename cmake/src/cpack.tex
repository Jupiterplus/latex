\section{CPack: Packaging made easy}
\begin{frame}
\frametitle{Introduction}
\begin{block}{A Package \textbf{generator}}
In the same way that CMake \emph{generates} build files, CPack
\emph{generates} package files.
\end{block}

\begin{multicols}{2}
\begin{itemize}
\item Archive generators [ZIP,TGZ,\ldots] (All platforms)
\item DEB, RPM (Linux)
\item Cygwin Source or Binary (Windows/Cygwin)
\item NSIS (Windows, Linux)
\item DragNDrop, Bundle, OSXX11 (Mac OS)
\end{itemize}
\columnbreak
\includegraphics[width=5cm]{CPack-logo-3D-opened-v2} \\
\end{multicols}
\end{frame}

\section{CPack with CMake}

\againframe<6>{cmakeworkflow}

\begin{frame}
\frametitle{The CPack application}
\begin{block}{CPack standalone}
CPack is a standalone application whose behavior is
driven by a configuration file e.g. \fname{CPackConfig.cmake}.
This file is a CMake language script which defines
\lstinline!CPACK_XXXX! variables:

the config parameters of the CPack run.
\end{block}
\begin{block}{CPack with CMake}
When CPack is used to package a project built with CPack,
then the CPack configuration is usually generated by CMake by
including \fname{CPack.cmake} in the main \fname{CMakeLists.txt}:

\lstinline!include(CPack)!
\end{block}
\end{frame}

\begin{frame}[fragile]
\frametitle{CPack variables in \fname{CMakeLists.txt}}
When used with CMake, one writes something like this in \fname{CMakeLists.txt}:
\begin{lstlisting}[language=cmake,numbers=left]
set(CPACK_GENERATOR "TGZ")
if (WIN32)
   list(APPEND CPACK_GENERATOR "NSIS")
elseif (APPLE)
   list(APPEND CPACK_GENERATOR "Bundle")
endif(WIN32)
set(CPACK_SOURCE_GENERATOR "ZIP;TGZ")
set(CPACK_PACKAGE_VERSION_MAJOR 0)
set(CPACK_PACKAGE_VERSION_MINOR 1)
set(CPACK_PACKAGE_VERSION_PATCH 0)
include(CPack)
\end{lstlisting}
This will create \fname{CPackSourceConfig.cmake} and \fname{CPackConfig.cmake}
in the build tree and will bring you the \emph{\fname{package}} and \emph{\fname{package\_source}}
built-in targets.
\end{frame}

\begin{frame}[fragile, allowframebreaks]
\frametitle{A CPack config file}
A CPack config file looks like this one:
\begin{lstlisting}[language=cmake,numbers=left,breaklines=true]
# This file will be configured to contain variables for CPack.
# These variables should be set in the CMake list file of the
# project before CPack module is included.
...
SET(CPACK_BINARY_BUNDLE "")
SET(CPACK_BINARY_CYGWIN "")
SET(CPACK_BINARY_DEB "")
...
SET(CPACK_BINARY_ZIP "")
SET(CPACK_CMAKE_GENERATOR "Unix Makefiles")
SET(CPACK_GENERATOR "TGZ")
SET(CPACK_INSTALL_CMAKE_PROJECTS "/home/erk/erkit/CMakeTutorial/examples/build;TotallyFree;ALL;/")
SET(CPACK_INSTALL_PREFIX "/usr/local")
SET(CPACK_MODULE_PATH "")
SET(CPACK_NSIS_DISPLAY_NAME "TotallyFree 0.1.0")
SET(CPACK_NSIS_INSTALLER_ICON_CODE "")
SET(CPACK_NSIS_INSTALL_ROOT "$PROGRAMFILES")
SET(CPACK_NSIS_PACKAGE_NAME "TotallyFree 0.1.0")
SET(CPACK_OUTPUT_CONFIG_FILE "/home/erk/erkit/CMakeTutorial/examples/build/CPackConfig.cmake")
SET(CPACK_PACKAGE_DEFAULT_LOCATION "/")
SET(CPACK_PACKAGE_DESCRIPTION_FILE "/home/erk/CMake/cmake-Verk-HEAD/share/cmake-2.8/Templates/CPack.GenericDescription.txt")
SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "TotallyFree built using CMake")
SET(CPACK_PACKAGE_FILE_NAME "TotallyFree-0.1.0-Linux")
SET(CPACK_PACKAGE_INSTALL_DIRECTORY "TotallyFree 0.1.0")
SET(CPACK_PACKAGE_INSTALL_REGISTRY_KEY "TotallyFree 0.1.0")
SET(CPACK_PACKAGE_NAME "TotallyFree")
SET(CPACK_PACKAGE_RELOCATABLE "true")
SET(CPACK_PACKAGE_VENDOR "Humanity")
SET(CPACK_PACKAGE_VERSION "0.1.0")
SET(CPACK_RESOURCE_FILE_LICENSE "/home/erk/CMake/cmake-Verk-HEAD/share/cmake-2.8/Templates/CPack.GenericLicense.txt")
SET(CPACK_RESOURCE_FILE_README "/home/erk/CMake/cmake-Verk-HEAD/share/cmake-2.8/Templates/CPack.GenericDescription.txt")
SET(CPACK_RESOURCE_FILE_WELCOME "/home/erk/CMake/cmake-Verk-HEAD/share/cmake-2.8/Templates/CPack.GenericWelcome.txt")
SET(CPACK_SET_DESTDIR "OFF")
SET(CPACK_SOURCE_CYGWIN "")
SET(CPACK_SOURCE_GENERATOR "TGZ;TBZ2;TZ")
SET(CPACK_SOURCE_OUTPUT_CONFIG_FILE "/home/erk/erkit/CMakeTutorial/examples/build/CPackSourceConfig.cmake")
SET(CPACK_SOURCE_TBZ2 "ON")
SET(CPACK_SOURCE_TGZ "ON")
SET(CPACK_SOURCE_TZ "ON")
SET(CPACK_SOURCE_ZIP "OFF")
SET(CPACK_SYSTEM_NAME "Linux")
SET(CPACK_TOPLEVEL_TAG "Linux")
\end{lstlisting}
%$
\end{frame}

\begin{frame}[fragile, allowframebreaks]
\frametitle{CPack running steps}
For a CMake enabled project one can run CPack in two ways:
\begin{enumerate}
\item use the build tool to run targets: \fname{package} or \fname{package\_source}
\item invoke CPack manually from within the \emph{build tree} e.g.:

      \fname{\$ cpack -G RPM}
\end{enumerate}
The CPack documentation is currently found on the Wiki or
on the CPack specific modules:
\begin{itemize}
\item \url{https://cmake.org/Wiki/CMake:CPackPackageGenerators}
\item \url{https://cmake.org/Wiki/CMake:Component_Install_With_CPack}
\item \fname{cpack --help-module CPackXXX} with CPack, CPackComponent, CPackRPM, CPackDEB, CPackIFW, CPackWIX, \ldots
\end{itemize}

Whichever way you call it, the CPack steps are:
\begin{enumerate}
\item cpack command starts and parses arguments etc\ldots
\item it reads \fname{CPackConfig.cmake} (usually found in the build tree)
      or the file given as an argument to \fname{--config} command line option.
\item it iterates over the generators list found in \fname{CPACK\_GENERATOR}
      (or from \fname{-G} command line option). For each generator:
      \begin{enumerate}
      \item (re)sets \fname{CPACK\_GENERATOR} to the one currently being iterated over
      \item includes the \fname{CPACK\_PROJECT\_CONFIG\_FILE}
      \item installs the project into a CPack private location (using \fname{DESTDIR})
      \item calls the generator and produces the package(s) for that generator
      \end{enumerate}
\end{enumerate}

\begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize,numbers=left,frame=topline,label=cpack command line example]
$ cpack -G "TGZ;RPM"
\textcolor{blue}{CPack: Create package using TGZ}
CPack: Install projects
CPack: - Run preinstall target for: TotallyFree
CPack: - Install project: TotallyFree
CPack: Create package
CPack: - package: <...>/build/\textcolor{blue}{TotallyFree-0.1.0-Linux.tar.gz} generated.
\textcolor{blue}{CPack: Create package using RPM}
CPack: Install projects
CPack: - Run preinstall target for: TotallyFree
CPack: - Install project: TotallyFree
CPack: Create package
{\tiny CPackRPM: Will use GENERATED spec file: <...>/build/_CPack_Packages/Linux/RPM/SPECS/totallyfree.spec}
CPack: - package: <...>/build/\textcolor{blue}{TotallyFree-0.1.0-Linux.rpm} generated.
$
\end{Verbatim}
% $
\begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize,numbers=left,frame=topline,label=make package example]
$ make package
[ 33%] Built target acrodict
[ 66%] Built target Acrodictlibre
[100%] Built target Acrolibre
Run CPack packaging tool...
CPack: Create package using TGZ
CPack: Install projects
CPack: - Run preinstall target for: TotallyFree
CPack: - Install project: TotallyFree
CPack: Create package
CPack: - package: <...>/build/TotallyFree-0.1.0-Linux.tar.gz generated.
\end{Verbatim}
%$
\begin{alertblock}{Rebuild project}
 In the \fname{make package} case CMake is checking that the project does not need a rebuild.
\end{alertblock}

\begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize,numbers=left,frame=topline,label=make package\_source example]
$ make package_source
make package_source 
Run CPack packaging tool for source...
CPack: Create package using TGZ
CPack: Install projects
CPack: - Install directory: <...>/totally-free
CPack: Create package
CPack: - package: <...>/build/TotallyFree-0.1.0-Source.tar.gz generated.
CPack: Create package using TBZ2
CPack: Install projects
CPack: - Install directory: <...>/totally-free
CPack: Create package
CPack: - package: <...>/build/TotallyFree-0.1.0-Source.tar.bz2 generated.
CPack: Create package using TZ
CPack: Install projects
CPack: - Install directory: <...>/totally-free
CPack: Create package
CPack: - package: <...>/build/TotallyFree-0.1.0-Source.tar.Z generated.
\end{Verbatim}
%$
\end{frame}

\begin{frame}[label=cpackworkflow]
\frametitle{The CPack workflow (pictured)}
\begin{tikzpicture}[
sbase/.style={      % The shape:
                    rectangle,
                    % The size:
                    minimum size=2mm,
                    minimum width=2.0cm,
                    minimum width=0.5cm,
                    % The border:
                    thick,
                    draw=black!50!black!50,
                    % 50% red and 50% black,
                    % and that mixed with 50% white
                    % The filling:
                    top color=white,
                    % a shading that is white at the top...
                    bottom color=red!80!black!20, % and something else at the bottom
                    % Font
                    font=\itshape\scriptsize}
                    ]
\tikzstyle{edited} = [sbase,
                      draw,
                      bottom color=green!80!black!20,
                      %opacity=.5,
                      %fill=green!20,
                      rounded corners]
\tikzstyle{generated} = [sbase,
                      draw,
                      %dashed,
                      bottom color=red!80!black!20,
                      %opacity=.5,
                      %fill=green!20,
                      rounded corners]
\tikzstyle{installed} = [sbase,
                      draw,
                      bottom color=blue!80!black!20,
                      %opacity=.5,
                      %fill=green!20,
                      rounded corners]
\tikzstyle{pkg} = [installed,
                  dashed,
                  general shadow={fill=blue!60!black!40,shadow scale=1.05,shadow xshift=+2pt,shadow yshift=-2pt}
                  ]
\tikzstyle{boitearrondie} = [draw,
                             dashed,
                             opacity=.5,
                             fill=blue!20,
                             rounded corners]
\onslide<1->{
\node[edited] (cmakelists) {\begin{tabular}{c}
                            CMakeLists.txt
                           \end{tabular}
                            };
\node[edited,below=1cm and 0cm of cmakelists.south] (sourcefiles)
                           {\begin{tabular}{c}
                            Source files
                           \end{tabular}
                           };
            }
\onslide<4->{
\node[generated,right=0cm and 1.6cm of cmakelists.east] (cpackconf)
                           {\begin{tabular}{c}
                            CPackConfig.cmake
                           \end{tabular}
                           };
\node[generated,below=2.7cm and 0.0cm of cpackconf.south] (cpacksconf)
                           {\begin{tabular}{c}
                            CPackSourceConfig.cmake
                           \end{tabular}
                           };
            }
\node[below=1cm and -0.2cm of sourcefiles.south west] (legendL){};
\node[right=0cm and 2.3cm of legendL.east] (legendR){};
\onslide<5->{
\node[pkg, below=0.7cm and 0cm of cpacksconf.south] (spackage)
                            {\begin{tabular}{c}
                              Source \\
                              package
                            \end{tabular}
                            };
}

\onslide<7->{
\node[pkg, below=1.2cm and 0cm of cpackconf.south] (bpackage)
                            {\begin{tabular}{c}
                              Binary \\
                              package
                            \end{tabular}
                            };
           }
\onslide<8->{
\node[installed, right=0.0cm and 4.0cm of bpackage.west] (ipackage)
                            {\begin{tabular}{c}
                              Installed \\
                              package
                            \end{tabular}
                            };

            }
\begin{pgfonlayer}{background}
\onslide<6->{
\node[installed, below right=0.1cm and 0.1cm of cpackconf.south] (binstalled)
                            {\tiny
                             \begin{tabular}{c}
                             CPack\\
                             Installed files
                            \end{tabular}
                            };
            }
\end{pgfonlayer}
\tikzstyle{cmaketime} = [-latex,thick,color=green]
\tikzstyle{buildtime} = [-latex,thick,color=red]
\tikzstyle{installtime} = [-latex,thick,color=black,postaction={draw,red,dash pattern=on 4pt off 3pt,dash phase=4pt,thick,color=blue}]
\tikzstyle{cpacktime} = [-latex,thick,color=blue]
\tikzstyle{packageinstalltime} = [-latex,thick,color=black,dashed]
\onslide<3->{
\draw [cmaketime]           ([yshift=0.0cm]legendL.south) -- ([yshift=0.0cm]legendR.south)  node[above=-2pt,midway,font=\tiny] {CMake time};
\draw [buildtime]          ([yshift=-0.5cm]legendL.south) -- ([yshift=-0.5cm]legendR.south) node[above=-2pt,midway,font=\tiny] {Build time};
\draw [installtime]        ([yshift=-1.0cm]legendL.south) -- ([yshift=-1.0cm]legendR.south) node[above=-2pt,midway,font=\tiny] {Install time (from CPack)};
\draw [cpacktime]          ([yshift=-1.5cm]legendL.south) -- ([yshift=-1.5cm]legendR.south) node[above=-2pt,midway,font=\tiny] {CPack time};
\draw [packageinstalltime] ([yshift=-2.0cm]legendL.south) -- ([yshift=-2.0cm]legendR.south) node[above=-2pt,midway,font=\tiny] {Package Install time};
}

\begin{pgfonlayer}{background2}
\onslide<2->{
\draw[boitearrondie,top color=blue,bottom color=green,middle color=red] ([xshift=-0.2cm,yshift=0.2cm]cmakelists.north west) rectangle ([xshift=0.3cm,yshift=-0.2cm]sourcefiles.south east);
\pgftext[top,at={\pgfpointadd{\pgfpoint{0.0cm}{-0.4cm}}{\pgfpointanchor{cmakelists}{south}}},rotate=20]{\scriptsize Source Tree};
}
\onslide<3->{
\draw[boitearrondie,top color=blue,bottom color=green,middle color=red] ([xshift=-0.6cm,yshift=0.2cm]cpackconf.north west) rectangle ([xshift=1.4cm,yshift=-0.2cm]spackage.south east);
\pgftext[top,at={\pgfpointadd{\pgfpoint{-0.4cm}{0.8cm}}{\pgfpointanchor{bpackage}{west}}},rotate=40] {\scriptsize Build Tree};
\node (btree) {};
}
\end{pgfonlayer}

\begin{pgfonlayer}{background}
\onslide<4->{
\draw [cmaketime] (cmakelists) -- (cpackconf);
\draw [cmaketime] (cmakelists) -- (cpacksconf);
}
\onslide<5->{
\draw [cpacktime] ([yshift=0.2cm]sourcefiles.south) -- (spackage);
\draw [cpacktime] (cpacksconf) -- (spackage);
}
\onslide<7->{
\draw [cpacktime] ([xshift=-0.2cm]binstalled.south) -- ([xshift=0.2cm]bpackage.north);
\draw [cpacktime] (cpackconf) -- (bpackage);
}
\onslide<6->{
\draw [installtime] ([xshift=-1.4cm]binstalled.west) -- (binstalled);
}
\onslide<8->{
\draw [packageinstalltime] (bpackage.east) -- (ipackage.west);
}
\end{pgfonlayer}
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Source vs Binary Generators}
\alert{CPack does not really distinguish ``source'' from ``binaries''!!}
\begin{block}{CPack source package}
The CPack configuration file is: \fname{CPackSourceConfig.cmake}.
The CPack source generator is essentially packaging directories with
install, exclude and include rules.
\end{block}
\begin{block}{CPack binary package}
The CPack configuration file is: \fname{CPackConfig.cmake}.
Moreover CPack knows that a project is built with CMake and
inherits many properties from the install rules found in
the project.
\end{block}

\end{frame}

\section{Various package generators}
\begin{frame}
\frametitle{Archive Generators}
\begin{block}{A family of generators}
The archive generators is a family of generators which is supported
on all CMake supported platforms through \fname{libarchive}:
\url{http://code.google.com/p/libarchive/}.
\end{block}
\begin{itemize}
\item[STGZ] Self extracting Tar GZip compression
\item[TBZ2] Tar BZip2 compression
\item[TGZ]  Tar GZip compression
\item[TZ]   Tar Compress compression
\item[TXZ]  Tar XZ compression
\item[7Z]   7-zip archive
\item[ZIP]  Zip archive
\end{itemize}
\end{frame}

\begin{frame}[allowframebreaks]
\frametitle{Linux-friendly generators}
\begin{itemize}
\item Tar-kind archive generators
\item Binary RPM: only needs \fname{rpmbuild} to work.
\item Binary DEB: works on any Linux distros.
\item IFW: Qt Installer framework
\end{itemize}
\begin{block}{CPack vs native tools}
One could argue ``why use CPack for building .deb or .rpm''.
The primary target of CPack RPM and DEB generators are people who are NOT
professional packagers.
Those people can get a clean package without too much effort and get
a better package than a bare TAR archive.
\end{block}
\begin{alertblock}{No official packaging replacement}
Those generators are \alert{no replacement} for official packaging tools.
\end{alertblock}
\end{frame}

\begin{frame}
\frametitle{Windows-friendly generators}
\begin{itemize}
\item Zip archive generator
\item NullSoft System Installer generator: \url{http://nsis.sourceforge.net/}

      Supports component installation, produces nice GUI installer.
\item WiX installer: \url{http://wixtoolset.org/}

  Windows Installer XML which produces MSI.
\item IFW: Qt Installer framework
\item Cygwin: Binary and Source generators.
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Mac OS-friendly generators}
\begin{multicols}{2}
\begin{itemize}
\item Tar-kind archive generators
\item DragNDrop
\item PackageMaker
\item Bundle
\item OSXX11
\item may be Qt IFW as well...
\end{itemize}
\end{multicols}
\begin{alertblock}{Don't ask me}
I'm not a Mac OS user and I don't know them.
Go and read the CPack doc or ask on the ML.
\url{https://cmake.org/mailing-lists/}
\end{alertblock}
\end{frame}

\begin{frame}[fragile,allowframebreaks]
\frametitle{Packaging Components}

\begin{block}{CMake+CPack installation components?}
Sometimes you want to split the installer into \emph{components}.
\end{block}
\begin{enumerate}
\item Use \fname{COMPONENT} argument in your install rules
      (in the CMakeLists.txt),
\item Add some more [CPack] information about how to group
      components,
\item Choose a component-aware CPack generator
\item Choose the behavior (1 package file per component, 1 package file
      per group, etc\ldots)
\item Possibly specify generator specific behavior in \fname{CPACK\_PROJECT\_CONFIG\_FILE}
\item Run CPack.
\end{enumerate}

More detailed documentation here:

{\scriptsize \url{https://cmake.org/Wiki/CMake:Component_Install_With_CPack}}
\begin{alertblock}{Component aware generator}
\begin{itemize}
\item Not all generators do support components

      (i.e. they are \fname{MONOLITHIC})
\item Some produce a single package file containing all components.

      (e.g. NSIS, WiX, Qt IFW)
\item Others produce several package files containing one or several components.

      (e.g. ArchiveGenerator, RPM, DEB)
\end{itemize}
\end{alertblock}
\end{frame}


% \section{CPack and cross-compiling}


